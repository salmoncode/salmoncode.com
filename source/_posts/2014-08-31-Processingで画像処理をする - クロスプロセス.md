---
title: Processingで画像処理をする - クロスプロセス
date: 2014-08-31 17:39:36
category: プログラミング
tags: Processing
---

今回は「procesing で画像処理をする」の続編になるが、「デジタルクロスプロセス」という処理方法を述べたい。

いや、実はこの画像処理は手法が確立されていない技術で、大学で僕が考えた方法を改めてここに書き留めておきたいと思うのだ。

<!-- more -->

## クロスプロセスとは

そもそもクロスプロセスとは、## 写真を現像する際に用いられる技術である。写真を現像するときに持っていくフィルムにはポジフィルムとネガフィルムがある。いわゆる「ネガ」である。

これらにはそれぞれ対応する現像方法があり、それによって正しく現像されるのである。

クロスプロセスとは、この現像方法を入れかえてしまおうという手法である。

そして、これを現実のフィルムを使わずにデジタルで表現しようというのがデジタルクロスプロセスである。

## デジタルにおけるクロスプロセス

おそらくもっとも身近なデジタルクロスプロセスといえば「Instagram」というアプリだろう。画像を共有するサービスで、

Twitter や Facebook などへスマホの写真を投稿する時に画像を「ちょっといい感じ」に加工することができる。

こちらは専用のフィルターが用意されていて、非常にクロスプロセスっぽい画像ができあがる。ただ輝度をいじったりするのとは違い、独特の雰囲気が好まれているようだ。

<a href="https://instagram.com/">Instagram</a>

## Processing でクロスプロセス

前回、Processing を使うことで比較的簡単に画像処理ができることを述べた。

今回も、get()した情報に何らかの変更を加え、それを set()することで反映させる 1 ピクセル対 1 ピクセルの処理で実装したいと思う。

## どう実装するか

前述したとおり、デジタルクロスプロセスには決まった手法がない。そこで、僕はまず既存のデジタルクロスプロセスがどのように行われているのかを調べてみた。

僕が参考になると思ったのは Photoshop による処理方法であった。Photoshop にはトーンカーブでのコントラスト調整をする際に、クロスプロセスのテンプレートがあるらしいのだ。

僕は Photoshop のテンプレートの値をそのままプログラムに落とし込めば簡単に作れるのではないかと考えた。しかし、これではただのパクリだ。それによく調べてみると、多くの場合はこのテンプレートを画像によって好みになるように調節しながら使うらしいことが分かった。

そこで僕は、トーンカーブを使うというのはそのままに既存の数値にとらわれない新しい方法でデジタルクロスプロセスを実装することに決めた

## トーンカーブ

いきなり「トーンカーブ」という言葉を出してしまったが、まずはこれがどんなものか説明したい。トーンカーブとは、入力されるデータ値を x 軸に、出力されるデータ値を y 軸にとった時の x と y の関係をグラフに表したものである。多くの場合は曲線になる（例外ももちろんある）ため、トーン（色調）のカーブ（曲線）ということでトーンカーブと呼ばれる。

画像処理をするときに、r,g,b の全域に対して、一つ一つ数字を対応させるのは大変である。そこで、曲線をマウスをつかってグニャグニャいじることで感覚的にフィルターを作れるのである。

それでは、トーンカーブを数式と考えてみたらどうだろう？もしデジタルクロスプロセスに使われるテンプレートの”形”を数式で定義できれば、パラメータを変えることでより本物のクロスプロセスに近い処理をすることができるのでないだろうか。

## キーワードは”S 字”

さっそくいろんなサイトでトーンカーブについてみて回る。そして気付いたのだが、デジタルクロスプロセスに使われるトーンカーブは S 字の形をしていることが多い。曲率は違えど皆 S 字を使っている。これはラッキーである。S 字なら高校数学で散々付き合ったではないか。「3 次関数」があるじゃないか！

と、ここまでは安易に考えていたのだが、すぐに問題が発覚した。

3 次関数では自由度が高すぎるのだ。高校のときに極値だか変曲点だか習ったが、いずれも「無い」場合がある。つまり、3 次関数は必ずしも S 字になるとは限らないのだ。

なんとか S 字だけになるようにパラメータ（各項の係数）を制限しようと試みたものの、あれこれ数字が動くので難しすぎる。東工大の奴とかに解かせてみたいぐらいだ。「3 次関数が S 字となる係数を全てあげ、数式でその条件を述べよ」こんな問題を解く頭は僕にはないので、他の数式で S 字を作るものはないかと考える。

## シグモイド関数

そんな中で採用することにしたのがこのシグモイド関数。まさに S 字を描く関数で、パラメータも 2 つですむことが分かった。

数式は以下の通りである。まず、

```
G0 = 255/(1+exp(-γ(u-127.5)))
```

とおく。ここで γ（ガンマ）を 1/30 にすることで、u が 0~1 のときちょうど g が 0~255 になる。

これを以下の式のように組み込む。

```
yc=kc{xc+bc(G0(xc)-xc)}
```

xc が入力で yc が出力である。kc,bc がパラメータとなり、それぞれ 0~1 で指定すればよい。

これで準備は整った。

## コーディングする

以下がコードである。

<script src="https://gist.github.com/salmon2073/8a8caa6d59938369c31e.js"></script>

上のコードをただ写しただけでは真黒な画像になってしまう。パラメータとして、k<em>(r,g,b),b</em>(r,g,b)に 0~1 の値を入れることで、きちんと動くようになる。

処理前

<img src="https://www5469up.sakura.ne.jp/file/before_process.png" alt="" />

処理後

<img src="https://www5469up.sakura.ne.jp/file/after_process.png" alt="" />

## 終わりに

今回はデジタルクロスプロセスに焦点を当ててみた。実はこの勉強は続きがあるのだが…

次に画像処理について扱うときはグリッチとかテーマにしてみようと思う。
