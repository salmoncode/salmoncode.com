---
title: GCP無料枠でWordPressブログを運用する
date: 2019-10-13 15:17:11
tags:
---

このブログはGoogle Cloud Platform(GCP)の無料枠で利用できるCompute Engineのインスタンスを使って運用しています。今回はその方法を説明します。

※詳しい手順を説明しようと思ったのですが、スクリーンショットを撮るのが面倒だったので雑に書いてます。詳細は後々書き足すかも。

<!-- more -->

## なぜGCPなのか

一言で言えば、無料で運用したいからですねw

無料でWordPressを立ち上げる場合の候補としては、自宅サーバ、GCPやAWSなどのクラウドサービスの無料枠、無料レンタルサーバが挙げられます。

自宅サーバは物理的に管理が大変なので却下。

無料レンタルサーバは管理業者による広告が表示されたり、独自ドメインに対応していなかったりするのでこれも見送り。

となるとクラウドサービスの無料枠を使うことになるのですが、AWSやAzureの無料枠では残念ながら恒久的に無料とはいかず…

というわけでGCPを使うことにしました。

## Compute Engine

GCPには２種類の無料枠があります。

- 12ヶ月の期限付きクレジットが300$分使える
- サービスの一部をずっと使える

ブログは長く運用したいので後者だけで完結したいところですね。
ご安心ください。ありがたいことにCompute engineが含まれているので、これでWordPressを動かすことができます！

https://cloud.google.com/free/?hl=ja

## インスタンスの構築

ググってチュートリアル的なやつをやってくださいw
以下のような流れになります。

- （なければ）Googleアカウントを作る
- GCPのプロジェクトを作る
- 請求先アカウントを作って紐付け(要クレカ。支払いは発生しない)
- インスタンスを建てる(httpsを許可しておきましょう)

ちなみに、f1-microが使えるリージョンの中で日本に一番近いのがes-westだそうです。

OSはUbuntu18のLTSなやつを選びました。

あとこれは忘れがちなのですが、IPアドレスを固定しておくことをおすすめします。そうしないとインスタンスを再起動するたびにIPアドレスが変わってしまい、ドメインの向き先を変えないといけなくなってしまいます。

インスタンスの編集画面で、以下の通りに設定します。

- ネットワーク インターフェースを選択
- 外部IPの選択ボックスを開き、「IPアドレスを作成」を選択
- できあがったIPアドレスに設定して保存

https://cloud.google.com/compute/docs/ip-addresses/reserve-static-external-ip-address?hl=ja

## ミドルウェアのインストール

よくある3点セット(Webサーバ、DBMS、プログラミング環境)をインストールして、いわゆるLAMP環境を構築します。

### Webサーバのインストール

nginxなりapacheなりH2Oなり、お好きなものをインストールしてください。
WordPressは.htaccessを使うので、apacheが一番easyだと思います。
一方で、弱小サーバなので少しでも負荷を減らすために他のミドルウェアを選択するのもアリですね。

とりあえずapacheのインストールコマンドを貼っておきます。

`sudo apt -y install apache2`

これでブラウザから外部IPでサーバにアクセスできるようになります。

### DBMSのインストール・DBの作成

MySQLかmariaDBをインストールします。基本的に以下でok。

`sudo apt -y install mysql-server mysql-client`

インストールしたら、WordPressのデータを保存するためのDBを一つ作っておきましょう。

### PHPのインストール

これもググればたくさんでてきますが、とりあえず以下でよいかと

`sudo apt -y install php7.2 php7.2-mysql`

## WordPressのインストール

今時FTPであげるのも面倒なので、インスタンスでダウンロードしちゃいます。

`wget https://ja.wordpress.org/latest-ja.zip`

unzipで解凍してドキュメントルートへ移動し、以下のコマンドで所有者をwebサーバの実行ユーザにします。

```
unzip latest-ja.zip
sudo mv [WordPressのディレクトリ] /var/www/html/
sudo chown -R www-data:www-data /var/www/html/[WordPressのディレクトリ]
```

https://ja.wordpress.org

## ドメインの設定

ドメインはお名前ドットコムで取得しました。（ここだけお金かかってます。年1500円くらい。）
管理画面がわかりにくくてレコードの設定に時間がかかってしまったので、設定方法をここにメモしておきます。

- お名前.com Naviにログインし、ドメイン設定のページを開く。
- 「ネームサーバーの設定」にある「DNS設定/転送設定」を選択。
- ドメインを選択して次へ進む
- またメニューが出てくるので、「DNSレコード設定を利用する」を選択
- `TYPE`を`A`にして、`VALUE`の部分にインスタンスの「外部 IP」を入力
- 確認画面へ進み、設定して完了

これでドメインからサイトを表示できるようになったはず。

## SSL証明書の設定

Chromeなんかはデフォルトでhttpsでアクセスしてくるので、SSL証明書を設定する必要があります。
無料で利用可能なLet's Encryptを使います。

https://letsencrypt.org/ja/

## ブログの立ち上げ

ここからはブラウザ上で作業します。
WordPressをインストールしたURLにアクセスすると、ブログの設定を行うためのガイドが出てくるので、それにしたがってインストールしてください。

あとは好みのテーマをインストールすればサイト完成です。

## おわりに

書いていて思いましたが、意外とやることが多いですね…
僕はWebサーバのインストールで手戻りがあったので、全体でだいたい2~3時間くらいかかりました。

レガシーな運用方法ですが、プライベートでGCPを軽く触るには良い題材だと思います。プロジェクトなどの概念がわかってきたら、各種サービスを試していきたいですね。

今回はサイトの立ち上げまでを書きましたが、運用にあたってWordPressプラグインをいくつか利用しているので、それについてもまた書きたいと思います。